apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
data:
  init-db.sh: |
    #!/bin/bash
    set -e

    # Create databases for each service
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
        -- Create databases
        CREATE DATABASE user_db;
        CREATE DATABASE auth_db;
        CREATE DATABASE board_db;
        CREATE DATABASE chat_db;
        CREATE DATABASE noti_db;

        -- Create users for each service
        CREATE USER user_service WITH PASSWORD 'user_service_pass';
        CREATE USER auth_service WITH PASSWORD 'auth_service_pass';
        CREATE USER board_service WITH PASSWORD 'board_service_pass';
        CREATE USER chat_service WITH PASSWORD 'chat_service_pass';
        CREATE USER noti_service WITH PASSWORD 'noti_service_pass';

        -- Grant privileges
        GRANT ALL PRIVILEGES ON DATABASE user_db TO user_service;
        GRANT ALL PRIVILEGES ON DATABASE auth_db TO auth_service;
        GRANT ALL PRIVILEGES ON DATABASE board_db TO board_service;
        GRANT ALL PRIVILEGES ON DATABASE chat_db TO chat_service;
        GRANT ALL PRIVILEGES ON DATABASE noti_db TO noti_service;
    EOSQL

    # Grant schema privileges for each database
    for db in user_db auth_db board_db chat_db noti_db; do
        user="${db%_db}_service"
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" -d "$db" <<-EOSQL
            GRANT ALL ON SCHEMA public TO $user;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $user;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO $user;
    EOSQL
    done

    echo "Database initialization completed!"
