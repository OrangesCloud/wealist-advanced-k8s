# =============================================================================
# Video Service - Standalone Docker Compose
# =============================================================================
# 독립 실행용 Docker Compose 설정입니다.
# 전체 weAlist 프로젝트와 별개로 video-service만 테스트할 때 사용합니다.
#
# 사용법:
#   docker compose up -d
#   또는
#   docker compose up --build
# =============================================================================

services:
  # Video Service (Go)
  video-service:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: wealist/video-service:${VERSION:-latest}
    container_name: video-service
    hostname: video-service
    ports:
      - "${VIDEO_HOST_PORT:-8004}:8004"

    environment:
      # Server Configuration
      - ENV=${ENV:-dev}
      - PORT=8004
      - SERVER_BASE_PATH=/api/video
      - LOG_LEVEL=${LOG_LEVEL:-debug}

      # Database Configuration
      - DATABASE_URL=postgresql://${VIDEO_DB_USER:-video_service}:${VIDEO_DB_PASSWORD:-video_service_password}@postgres:5432/${VIDEO_DB_NAME:-wealist_video_db}?sslmode=disable

      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis_password}

      # Auth Service (standalone 모드에서는 JWT 로컬 검증 사용)
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://host.docker.internal:8080}
      - SECRET_KEY=${SECRET_KEY:-your-super-secret-jwt-key-change-this-in-production-min-32-chars}

      # User Service (optional)
      - USER_SERVICE_URL=${USER_SERVICE_URL:-http://host.docker.internal:8081}

      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-*}

      # LiveKit Configuration
      - LIVEKIT_HOST=http://livekit:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - LIVEKIT_WS_URL=${LIVEKIT_WS_URL:-ws://localhost:7880}

    networks:
      - video-net

    extra_hosts:
      - "host.docker.internal:host-gateway"

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      livekit:
        condition: service_started

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8004/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    restart: unless-stopped

  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: video-postgres
    hostname: postgres
    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"

    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${VIDEO_DB_NAME:-wealist_video_db}

    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro

    networks:
      - video-net

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7.2-alpine
    container_name: video-redis
    hostname: redis
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"

    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-redis_password}
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru

    networks:
      - video-net

    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-redis_password}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

    restart: unless-stopped

  # LiveKit SFU Server - WebRTC Media Server
  livekit:
    image: livekit/livekit-server:v1.5
    container_name: video-livekit
    hostname: livekit
    ports:
      - "7880:7880"                       # HTTP API & WebSocket
      - "7881:7881"                       # TCP for WebRTC
      - "50000-50020:50000-50020/udp"     # UDP for WebRTC media

    command: --config /etc/livekit.yaml

    volumes:
      - ./docker/livekit.yaml:/etc/livekit.yaml:ro

    networks:
      - video-net

    restart: unless-stopped

  # coturn TURN/STUN Server - NAT Traversal
  coturn:
    image: coturn/coturn:4.6
    container_name: video-coturn
    hostname: coturn
    ports:
      - "3478:3478"           # STUN/TURN UDP
      - "3478:3478/udp"       # STUN/TURN UDP
      - "5349:5349"           # STUN/TURN TLS
      - "5349:5349/udp"       # STUN/TURN TLS UDP

    volumes:
      - ./docker/turnserver.conf:/etc/coturn/turnserver.conf:ro

    command: -c /etc/coturn/turnserver.conf

    networks:
      - video-net

    restart: unless-stopped

networks:
  video-net:
    driver: bridge
    name: video-service-net

volumes:
  postgres-data:
    name: video-postgres-data
    driver: local
