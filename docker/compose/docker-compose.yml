# =============================================================================
# weAlist Project - Docker Compose Configuration (Development)
# =============================================================================
# 로컬 개발 환경용 Docker Compose 설정입니다.
#
# 사용법:
#   ./docker/scripts/dev.sh up
#   또는
#   docker compose -f docker/compose/docker-compose.yml up
# =============================================================================

services:
  # ===========================================================================
  # Backend Services
  # ===========================================================================

  # User Service (Spring Boot)
  user-service:
    build:
      context: ../../services/user-service
      dockerfile: Dockerfile
      args:
        CACHEBUST: ${CACHEBUST:-1}
    image: wealist/user-service:${VERSION:-latest}
    container_name: wealist-user-service
    hostname: user-service

    env_file:
      - ../env/.env.dev

    ports:
      - "${USER_HOST_PORT:-8090}:8080"

    environment:
      # Server Configuration
      - SERVER_PORT=8080
      - USER_SERVICE_PORT=8080
      - APP_NAME=${APP_NAME}

      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/${USER_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${USER_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${USER_DB_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver

      # JPA/Hibernate Configuration
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - SPRING_JPA_SHOW_SQL=true
      - SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=true
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect

      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      - SPRING_REDIS_DATABASE=0

      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION_MS=${JWT_ACCESS_TOKEN_EXPIRATION_MS}
      - JWT_REFRESH_TOKEN_EXPIRATION_MS=${JWT_REFRESH_TOKEN_EXPIRATION_MS}

      # OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # Service URLs
      - BOARD_SERVICE_URL=http://board-service:8000

      # S3 Configuration
      - AWS_S3_BUCKET=${S3_BUCKET}
      - AWS_S3_REGION=${S3_REGION}
      - AWS_S3_ENDPOINT=${S3_ENDPOINT}
      - AWS_S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - AWS_S3_SECRET_KEY=${S3_SECRET_KEY}

      # Sample Data Configuration
      - SAMPLE_DATA_ENABLED=${SAMPLE_DATA_ENABLED:-false}

      # Dev Settings
      - SPRING_PROFILES_ACTIVE=dev
      - LOGGING_LEVEL_ROOT=INFO

      # Java Options
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0

    networks:
      - frontend-net
      - backend-net
      - database-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "-q",
          "--spider",
          "http://localhost:8080/actuator/health/liveness",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Auth Service (Spring Boot) - 토큰 관리 전용
  auth-service:
    build:
      context: ../../services/auth-service
      dockerfile: Dockerfile
      args:
        CACHEBUST: ${CACHEBUST:-1}
    image: wealist/auth-service:${VERSION:-latest}
    container_name: wealist-auth-service
    hostname: auth-service

    env_file:
      - ../env/.env.dev

    ports:
      - "${AUTH_HOST_PORT:-8080}:8090"

    environment:
      # Server Configuration
      - SERVER_PORT=8090
      - AUTH_SERVICE_PORT=8090
      - APP_NAME=${APP_NAME:-wealist-auth}

      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}

      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION_MS=${JWT_ACCESS_TOKEN_EXPIRATION_MS}
      - JWT_REFRESH_TOKEN_EXPIRATION_MS=${JWT_REFRESH_TOKEN_EXPIRATION_MS}

      # OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - OAUTH2_CLIENT_REDIRECT_URI=${OAUTH2_CLIENT_REDIRECT_URI:-http://localhost:8080/login/oauth2/code/google}
      - OAUTH2_REDIRECT_URL_ENV=${OAUTH2_REDIRECT_URL:-http://localhost:3000/oauth/callback}

      # User Service URL (OAuth 로그인 시 유저 조회/생성용)
      - USER_SERVICE_URL=http://user-service:8080

      # Dev Settings
      - SPRING_PROFILES_ACTIVE=dev
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY=DEBUG

      # Java Options
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0

    networks:
      - frontend-net
      - backend-net
      - database-net

    depends_on:
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "-q",
          "--spider",
          "http://localhost:8090/actuator/health/liveness",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Board Service (Go)
  board-service:
    build:
      context: ../../services/board-service
      dockerfile: docker/Dockerfile
    image: wealist/board-service:${VERSION:-latest}
    container_name: wealist-board-service
    hostname: board-service

    env_file:
      - ../env/.env.dev

    ports:
      - "${BOARD_HOST_PORT:-8000}:8000"

    environment:
      # Server Configuration
      - ENV=dev
      - BOARD_SERVER_PORT=8000
      - LOG_LEVEL=debug
      - BOARD_USE_AUTO_MIGRATE=true

      # Database Configuration
      - DATABASE_URL=postgresql://${BOARD_DB_USER}:${BOARD_DB_PASSWORD}@postgres:5432/${BOARD_DB_NAME}?sslmode=disable

      # Redis Configuration
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1

      # JWT Configuration (로컬 검증용 - fallback)
      - SECRET_KEY=${JWT_SECRET}

      # Service URLs
      - USER_SERVICE_URL=http://user-service:8080
      - AUTH_SERVICE_URL=http://auth-service:8090

      # S3 Configuration
      - S3_BUCKET=${S3_BUCKET}
      - S3_REGION=${S3_REGION}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}

      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS}

    networks:
      - frontend-net
      - backend-net
      - database-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      minio:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Chat Service (Go)
  chat-service:
    build:
      context: ../../services/chat-service
      dockerfile: docker/Dockerfile
    image: wealist/chat-service:${VERSION:-latest}
    container_name: wealist-chat-service
    hostname: chat-service

    env_file:
      - ../env/.env.dev

    ports:
      - "${CHAT_HOST_PORT:-8001}:8001"

    environment:
      - ENV=dev
      - SERVER_PORT=8001
      - SERVER_BASE_PATH=/api/chats
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${CHAT_DB_USER}:${CHAT_DB_PASSWORD}@postgres:5432/${CHAT_DB_NAME}?sslmode=disable
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
      - SECRET_KEY=${JWT_SECRET}
      - USER_SERVICE_URL=http://user-service:8080/api/users
      - AUTH_SERVICE_URL=http://auth-service:8090
      - CORS_ORIGINS=${CORS_ORIGINS}

    networks:
      - frontend-net
      - backend-net
      - database-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "-q",
          "--spider",
          "http://localhost:8001/api/chats/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # NGINX - API Gateway
  nginx:
    image: nginx:alpine
    container_name: wealist-nginx
    hostname: nginx

    ports:
      - "80:80"

    volumes:
      - ../nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro

    networks:
      - frontend-net
      - backend-net

    depends_on:
      - user-service
      - auth-service
      - board-service
      - chat-service

    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 80 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend Service
  frontend-service:
    build:
      context: ../../services/frontend
      dockerfile: Dockerfile.local
    image: wealist/frontend:${VERSION:-latest}
    container_name: wealist-frontend
    hostname: frontend

    env_file:
      - ../env/.env.dev

    ports:
      - "${FRONTEND_HOST_PORT:-3000}:5173"

    volumes:
      # 소스코드 Hot Reload
      - ../../services/frontend:/app
      - /app/node_modules

    command: pnpm dev --host 0.0.0.0 --port 5173 --strictPort

    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://localhost
      - LOG_LEVEL=debug

    networks:
      - frontend-net
      - backend-net

    depends_on:
      - nginx

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5173/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # Infrastructure Services
  # ===========================================================================

  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: wealist-postgres
    hostname: postgres

    env_file:
      - ../env/.env.dev

    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"

    environment:
      - POSTGRES_USER=${POSTGRES_SUPERUSER}
      - POSTGRES_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - POSTGRES_INITDB_ARGS=--locale-provider=icu --icu-locale=en-US
      - USER_DB_NAME=${USER_DB_NAME}
      - USER_DB_USER=${USER_DB_USER}
      - USER_DB_PASSWORD=${USER_DB_PASSWORD}
      - BOARD_DB_NAME=${BOARD_DB_NAME}
      - BOARD_DB_USER=${BOARD_DB_USER}
      - BOARD_DB_PASSWORD=${BOARD_DB_PASSWORD}
      - CHAT_DB_NAME=${CHAT_DB_NAME}
      - CHAT_DB_USER=${CHAT_DB_USER}
      - CHAT_DB_PASSWORD=${CHAT_DB_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_HOST_AUTH_METHOD=trust

    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../init/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro

    networks:
      - database-net

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SUPERUSER} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    user: postgres

  # Redis Cache
  redis:
    image: redis:7.2-alpine
    container_name: wealist-redis
    hostname: redis

    env_file:
      - ../env/.env.dev

    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"

    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --databases 16
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no

    volumes:
      - redis-data:/data

    networks:
      - database-net

    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "--no-auth-warning",
          "-a",
          "${REDIS_PASSWORD}",
          "ping",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MinIO - S3 Compatible Object Storage
  minio:
    image: minio/minio:latest
    container_name: wealist-minio
    hostname: minio

    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"

    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_DOMAIN=minio
      - MINIO_REGION_NAME=${AWS_REGION:-ap-northeast-2}

    volumes:
      - minio-data:/data

    command: server /data --console-address ":9001"

    networks:
      - backend-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MinIO Client - Create bucket on startup
  minio-init:
    image: minio/mc:latest
    container_name: wealist-minio-init
    depends_on:
      minio:
        condition: service_healthy

    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-wealist-dev-files}

    entrypoint: >
      /bin/sh -c "
      mc alias set minio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb minio/$${S3_BUCKET} --ignore-existing;
      mc anonymous set download minio/$${S3_BUCKET};
      echo 'MinIO bucket $${S3_BUCKET} created successfully';
      exit 0;
      "

    networks:
      - backend-net

# =============================================================================
# Networks
# =============================================================================
networks:
  frontend-net:
    driver: bridge
    name: wealist-frontend-net

  backend-net:
    driver: bridge
    name: wealist-backend-net

  database-net:
    driver: bridge
    name: wealist-database-net

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
    name: wealist-postgres-data
    driver: local

  redis-data:
    name: wealist-redis-data
    driver: local

  minio-data:
    name: wealist-minio-data
    driver: local
